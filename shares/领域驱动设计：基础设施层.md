# 领域驱动设计：基础设施层

> 本文已托管在 [github](https://github.com/StLeoX/domain-driven-hexagon)，喜欢的话点个 star 吧！

- [领域驱动设计：基础设施层](#领域驱动设计基础设施层)
- [基础设施层](#基础设施层)
  - [适配器](#适配器)
  - [数据仓库](#数据仓库)
  - [持久化模型](#持久化模型)


# 基础设施层

​    基础设施层对技术的保持负有严格的责任。可以在基础设施层找到业务实体、消息代理、I/O组件、依赖项注入、框架和其他任何描述架构细节的数据库和存储库的实现，同时基础设施层还囊括了框架依赖、外部依赖等项目依赖。

​    基础设施层也是最易于变化的一层。由于这一层中的代码很可能会发生变化，所以这些代码应当尽可能地远离更稳定的软件层。同时，因为基础设施层中的组件之间是隔离的，所以较为容易进行组件的重构，或将一个组件替换为另一个组件。

​    基础架构层可以包含“适配器”，也可以包含数据库相关代码，如“数据仓库”、“ORM实体和模式”，以及框架相关的代码等等。

## 适配器

- 基础设施层的适配器（也称为驱动适配器或二级适配器，区分于接口适配器）使软件系统能够在被请求时与外部系统进行交互，主要是通过接收、存储和提供数据，包括数据持久化、消息代理、发送电子邮件、请求第三方API等方式。

- 适配器还可以用于与单个过程中的不同域交互，以避免这些域之间的紧耦合。

- 适配器本质上是端口的实现。它们不应该在代码中的任何地方直接被调用，只能通过端口被调用。

- 适配器可以用作遗留代码的反腐败层（ACL，anti-corruption layer）。

​    关于ACL更多参阅： [Anti-Corruption Layer: How to Keep Legacy Support from Breaking New Systems](https://www.cloudbees.com/blog/anti-corruption-layer-how-keep-legacy-support-breaking-new-systems)

​    一个特定的适配器应当包含以下实现：

- 一个端口，实现在应用层或领域层的某处；
- 一个映射器，从领域映射出数据，或将数据映射到领域上（如果必要的话）；
- 一个DTO/接口，在接收数据的时候发挥作用；
- 一个验证器，来确保输入的数据未被破坏（验证工作可以放在DTO类中，交由装饰器来完成，也可以通过值对象来验证）。

## 数据仓库

​    数据仓库集中管理公共数据的访问功能。仓库封装了访问这些公共数据的特定逻辑。实体或聚合体可以放在数据仓库中，以便后期的检索。检索过程不依赖于特定的域，甚至不需要知道数据保存在数据库、文件还是其他数据源当中。

​    我们使用数据仓库将用于访问数据库的基础设施和基本过程，从领域模型层中解耦分离出来。

​    Martin Fowler对数据仓库的描述如下:

> 数据仓库在领域层和数据映射之间执行中介任务，其作用方式类似于内存中的**一组**域对象。客户端对象以声明的形式构建查询，并将查询发给数据仓库以获取结果。从概念上讲，数据仓库封装了一组存储在数据库中的对象和可以对其执行的增删改查操作，提供了一种更接近于持久层的方式。数据仓库的另一个优点是，在一个方向上清晰地分离了工作域与数据分配或数据映射之间的依赖关系。

​    这里的数据流看起来像这样：数据仓库从应用服务接收到一个域实体，将它映射成为数据库模式或ORM格式，执行所需的增删改查操作，并将操作结果映射回域实体，最后返回给服务。

​    **注意**，应用程序的核心层不允许直接依赖数据仓库，而应当依赖于更进一步的封装或抽象形式（如端口、接口的形式）。这使得数据的检索技术是不可知的。


## 持久化模型
未完，待更。
